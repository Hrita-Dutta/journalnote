@page "/entry"
@page "/entry/{DateParam}"
@using JournalNote.Components.Shared
@using JournalNote.Models
@using JournalNote.Services
@inject DatabaseService DatabaseService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Journal Entry</PageTitle>

<div class="container mt-4">
    <h2>@pageTitle</h2>
    <hr />

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @errorMessage
            <button class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show">
            @successMessage
            <button class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label"><strong>Date:</strong></label>
                <input type="date"
                       class="form-control"
                       value="@selectedDate.ToString("yyyy-MM-dd")"
                       @onchange="OnDateChanged" />
            </div>

            @if (isLoadingJournalEntry)
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2">Loading entry...</p>
                </div>
            }
            else
            {
                <div class="mb-3">
                    <label class="form-label"><strong>Title:</strong></label>
                    <input type="text"
                           class="form-control"
                           @bind="currentJournalEntry.Title"
                           maxlength="200"
                           placeholder="Enter title" />
                </div>

                <!-- Primary Mood -->
                <div class="mb-4">
                    <label class="form-label">
                        <strong>Primary Mood:</strong>
                        <span class="text-danger">*Required</span>
                    </label>
                    <MoodSelector
                        Title="How are you feeling today?"
                        MoodsByCategory="@moodsByCategory"
                        SelectedMoodId="@selectedPrimaryMoodId"
                        OnMoodSelected="@OnPrimaryMoodSelected"
                        MaxSelection="1"
                        AllowDeselect="false" />
                </div>

                <!-- Secondary Moods -->
                <div class="mb-4">
                    <label class="form-label">
                        <strong>Secondary Moods:</strong>
                        <span class="text-muted">(Optional - Up to 2)</span>
                    </label>
                    <MoodSelector
                        Title="Any other feelings?"
                        MoodsByCategory="@moodsByCategory"
                        SelectedMoodIds="@selectedSecondaryMoodIds"
                        OnMoodSelected="@OnSecondaryMoodSelected"
                        MaxSelection="2"
                        AllowDeselect="true" />
                </div>

                <!-- Tags Section -->
                <div class="mb-4">
                    <label class="form-label">
                        <strong>Tags:</strong>
                        <span class="text-muted">(Optional)</span>
                    </label>
                    <TagSelector
                        Title="Classify your entry"
                        AllTags="@allTags"
                        PredefinedTags="@predefinedTags"
                        CustomTags="@customTags"
                        SelectedTagIds="@selectedTagIds"
                        OnTagToggled="@OnTagToggled"
                        OnCustomTagAdded="@OnCustomTagAdded" />
                </div>

                <!-- Quill Editor -->
                <div class="mb-3">
                    <label class="form-label"><strong>Content:</strong></label>
                    <div id="editor"
                         style="height: 300px;background: white;border:2px solid #e0e6ed;border-radius:10px;">
                    </div>
                </div>

                <div class="d-flex gap-2 flex-wrap mt-4">
                    @if (isEditMode)
                    {
                        <button class="btn btn-primary" disabled="@isSaving" @onclick="UpdateJournalEntry">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Update Entry
                        </button>

                        <button class="btn btn-danger" disabled="@isSaving" @onclick="DeleteJournalEntry">
                            Delete Entry
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-success" disabled="@isSaving" @onclick="CreateJournalEntry">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            Save Entry
                        </button>
                    }

                    <button class="btn btn-secondary" @onclick="NavigateToHome">
                        Cancel
                    </button>
                </div>
            }
        </div>
    </div>

    @if (isEditMode && currentJournalEntry.Id > 0)
    {
        <div class="mt-3">
            <small class="text-muted">
                <strong>Created:</strong> @currentJournalEntry.CreatedAt.ToString("MMMM dd, yyyy h:mm tt")<br />
                <strong>Last Updated:</strong> @currentJournalEntry.UpdatedAt.ToString("MMMM dd, yyyy h:mm tt")
            </small>
        </div>
    }
</div>

@code {
    [Parameter] public string? DateParam { get; set; }

    private JournalEntry currentJournalEntry = new();
    private DateTime selectedDate = DateTime.Today;
    private bool isEditMode;
    private bool isLoadingJournalEntry;
    private bool isSaving;
    private bool quillReady;

    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private string pageTitle = "Create Journal Entry";

    // Moods
    private Dictionary<string, List<Mood>> moodsByCategory = new();
    private int? selectedPrimaryMoodId;
    private List<int> selectedSecondaryMoodIds = new();

    // Tags
    private List<Tag> allTags = new();
    private List<Tag> predefinedTags = new();
    private List<Tag> customTags = new();
    private List<int> selectedTagIds = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMoodsAsync();
        await LoadTagsAsync();

        if (DateTime.TryParse(DateParam, out var parsed))
            selectedDate = parsed;

        await LoadJournalEntryForDate();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initQuill", "editor");
            quillReady = true;
            await SyncQuillContent();
        }
    }

    private async Task LoadMoodsAsync()
    {
        try
        {
            var moods = await DatabaseService.GetAllMoodsAsync();
            moodsByCategory = moods.GroupBy(m => m.Category)
                                   .ToDictionary(g => g.Key, g => g.ToList());
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading moods: {ex.Message}";
        }
    }

    private async Task LoadTagsAsync()
    {
        try
        {
            allTags = await DatabaseService.GetAllTagsAsync();
            predefinedTags = await DatabaseService.GetPredefinedTagsAsync();
            customTags = await DatabaseService.GetCustomTagsAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading tags: {ex.Message}";
        }
    }

    private async Task OnDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?.ToString(), out var date))
        {
            selectedDate = date;
            await LoadJournalEntryForDate();
            await SyncQuillContent();
        }
    }

    private async Task LoadJournalEntryForDate()
    {
        isLoadingJournalEntry = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            var dateKey = selectedDate.ToString("yyyy-MM-dd");
            var entry = await DatabaseService.GetJournalEntryByDateAsync(dateKey);

            if (entry != null)
            {
                // Edit mode
                currentJournalEntry = entry;
                isEditMode = true;
                pageTitle = $"Edit Entry - {selectedDate:MMMM dd, yyyy}";

                // Load moods
                selectedPrimaryMoodId = entry.PrimaryMoodId;

                selectedSecondaryMoodIds = entry.SecondaryMoodIds?
                    .Split(',')
                    .Select(s => int.TryParse(s.Trim(), out var id) ? id : (int?)null)
                    .Where(id => id.HasValue)
                    .Select(id => id!.Value)
                    .ToList() ?? new();

                // Load tags
                selectedTagIds = entry.TagIds?
                    .Split(',')
                    .Select(s => int.TryParse(s.Trim(), out var id) ? id : (int?)null)
                    .Where(id => id.HasValue)
                    .Select(id => id!.Value)
                    .ToList() ?? new();
            }
            else
            {
                // Create mode
                currentJournalEntry = new JournalEntry { Date = dateKey };
                isEditMode = false;
                pageTitle = $"Create Entry - {selectedDate:MMMM dd, yyyy}";
                selectedPrimaryMoodId = null;
                selectedSecondaryMoodIds.Clear();
                selectedTagIds.Clear();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading entry: {ex.Message}";
        }
        finally
        {
            isLoadingJournalEntry = false;
        }
    }

    private Task OnPrimaryMoodSelected(int id)
    {
        selectedPrimaryMoodId = id;
        return Task.CompletedTask;
    }

    private Task OnSecondaryMoodSelected(int _) => Task.CompletedTask;

    private Task OnTagToggled(int _)
    {
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task OnCustomTagAdded(Tag newTag)
    {
        try
        {
            await DatabaseService.AddTagAsync(newTag);
            await LoadTagsAsync();

            var addedTag = allTags.FirstOrDefault(t => t.Name == newTag.Name);
            if (addedTag != null && !selectedTagIds.Contains(addedTag.Id))
            {
                selectedTagIds.Add(addedTag.Id);
            }

            successMessage = $"Custom tag '{newTag.Name}' added successfully!";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding custom tag: {ex.Message}";
        }
    }

    private async Task SyncQuillContent()
    {
        if (quillReady)
            await JS.InvokeVoidAsync("setQuillHtml", currentJournalEntry.Content ?? "");
    }

    private async Task CreateJournalEntry()
    {
        if (!await ValidateAndFillEntry()) return;

        isSaving = true;

        try
        {
            await DatabaseService.AddJournalEntryAsync(currentJournalEntry);
            successMessage = "Entry created successfully!";
            await LoadJournalEntryForDate();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task UpdateJournalEntry()
    {
        if (!await ValidateAndFillEntry()) return;

        isSaving = true;

        try
        {
            await DatabaseService.UpdateJournalEntryAsync(currentJournalEntry);
            successMessage = "Entry updated successfully!";
            await LoadJournalEntryForDate();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task<bool> ValidateAndFillEntry()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        if (string.IsNullOrWhiteSpace(currentJournalEntry.Title))
        {
            errorMessage = "Title is required.";
            return false;
        }

        if (!selectedPrimaryMoodId.HasValue)
        {
            errorMessage = "Primary mood is required.";
            return false;
        }

        var html = await JS.InvokeAsync<string>("getQuillHtml");
        if (string.IsNullOrWhiteSpace(html) || html == "<p><br></p>")
        {
            errorMessage = "Content is required.";
            return false;
        }

        currentJournalEntry.Content = html;
        currentJournalEntry.PrimaryMoodId = selectedPrimaryMoodId;
        currentJournalEntry.SecondaryMoodIds = string.Join(",", selectedSecondaryMoodIds);
        currentJournalEntry.TagIds = string.Join(",", selectedTagIds);

        return true;
    }

    private async Task DeleteJournalEntry()
    {
        var confirmed = await Application.Current.MainPage.DisplayAlert(
            "Confirm Delete",
            "Are you sure you want to delete this entry? This action cannot be undone.",
            "Yes, Delete",
            "Cancel"
        );

        if (!confirmed) return;

        isSaving = true;

        try
        {
            await DatabaseService.DeleteJournalEntryAsync(currentJournalEntry);
            successMessage = "Entry deleted successfully! Redirecting...";

            await Task.Delay(1000);
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void NavigateToHome() => Navigation.NavigateTo("/");
}
