@page "/entry"
@page "/entry/{DateParam}"
@using JournalNote.Models
@using JournalNote.Services
@inject DatabaseService DatabaseService
@inject NavigationManager Navigation

<PageTitle>Journal Entry</PageTitle>

<div class="container mt-4">
    <h2>@pageTitle</h2>
    <hr />

    @if (! string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (! string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string. Empty"></button>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label"><strong>Date:</strong></label>
                <input type="date" 
                       class="form-control" 
                       value="@selectedDate.ToString("yyyy-MM-dd")" 
                       @onchange="OnDateChanged" />
            </div>

            @if (isLoadingJournalEntry)
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading entry...</p>
                </div>
            }
            else
            {
                <div class="mb-3">
                    <label class="form-label"><strong>Title:</strong></label>
                    <input type="text" 
                           class="form-control" 
                           @bind="currentJournalEntry.Title" 
                           placeholder="Enter title" 
                           maxlength="200" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Content:</strong></label>
                    <textarea class="form-control" 
                              rows="10" 
                              @bind="currentJournalEntry.Content" 
                              placeholder="Write your thoughts here... "></textarea>
                </div>

                <div class="d-flex gap-2 flex-wrap">
                    @if (isEditMode)
                    {
                        <button class="btn btn-primary" @onclick="UpdateJournalEntry" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Update Entry
                        </button>
                        <button class="btn btn-danger" @onclick="DeleteJournalEntry" disabled="@isSaving">
                            Delete Entry
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-success" @onclick="CreateJournalEntry" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Save Entry
                        </button>
                    }
                    
                    <button class="btn btn-secondary" @onclick="NavigateToHome">
                        Cancel
                    </button>
                </div>
            }
        </div>
    </div>

    @if (isEditMode && currentJournalEntry != null && currentJournalEntry.Id > 0)
    {
        <div class="mt-3">
            <small class="text-muted">
                <strong>Created: </strong> @currentJournalEntry.CreatedAt.ToString("MMMM dd, yyyy h:mm tt")<br />
                <strong>Last Updated:</strong> @currentJournalEntry.UpdatedAt.ToString("MMMM dd, yyyy h:mm tt")
            </small>
        </div>
    }
</div>

@code {
    [Parameter]
    public string?  DateParam { get; set; }

    private JournalEntry currentJournalEntry = new JournalEntry();
    private DateTime selectedDate = DateTime.Today;
    private bool isEditMode = false;
    private bool isLoadingJournalEntry = false;
    private bool isSaving = false;
    private string errorMessage = string.Empty;
    private string successMessage = string. Empty;
    private string pageTitle = "Create Journal Entry";

    protected override async Task OnInitializedAsync()
    {
        // If date parameter provided in URL, use it
        if (!string.IsNullOrEmpty(DateParam))
        {
            if (DateTime.TryParse(DateParam, out DateTime parsedDate))
            {
                selectedDate = parsedDate;
            }
        }

        await LoadJournalEntryForDate();
    }

    private async Task OnDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e.Value?. ToString(), out DateTime newDate))
        {
            selectedDate = newDate;
            await LoadJournalEntryForDate();
        }
    }

    private async Task LoadJournalEntryForDate()
    {
        isLoadingJournalEntry = true;
        errorMessage = string. Empty;
        successMessage = string.Empty;

        try
        {
            string dateString = selectedDate.ToString("yyyy-MM-dd");
            var existingJournalEntry = await DatabaseService. GetJournalEntryByDateAsync(dateString);

            if (existingJournalEntry != null)
            {
                // Journal entry exists - switch to edit mode
                currentJournalEntry = existingJournalEntry;
                isEditMode = true;
                pageTitle = $"Edit Entry - {selectedDate: MMMM dd, yyyy}";
            }
            else
            {
                // No journal entry - create new
                currentJournalEntry = new JournalEntry
                {
                    Date = dateString,
                    Title = string.Empty,
                    Content = string.Empty
                };
                isEditMode = false;
                pageTitle = $"Create Entry - {selectedDate:MMMM dd, yyyy}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading entry:  {ex.Message}";
        }
        finally
        {
            isLoadingJournalEntry = false;
        }
    }

    private async Task CreateJournalEntry()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // Validation
        if (string.IsNullOrWhiteSpace(currentJournalEntry.Title))
        {
            errorMessage = "Please enter a title. ";
            return;
        }

        if (string.IsNullOrWhiteSpace(currentJournalEntry.Content))
        {
            errorMessage = "Please enter some content.";
            return;
        }

        isSaving = true;

        try
        {
            currentJournalEntry.Date = selectedDate.ToString("yyyy-MM-dd");
            await DatabaseService.AddJournalEntryAsync(currentJournalEntry);
            
            successMessage = "Entry created successfully!";
            
            // Reload journal entry to get generated ID and timestamps
            await LoadJournalEntryForDate();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task UpdateJournalEntry()
    {
        errorMessage = string. Empty;
        successMessage = string.Empty;

        // Validation
        if (string.IsNullOrWhiteSpace(currentJournalEntry.Title))
        {
            errorMessage = "Please enter a title.";
            return;
        }

        if (string.IsNullOrWhiteSpace(currentJournalEntry. Content))
        {
            errorMessage = "Please enter some content. ";
            return;
        }

        isSaving = true;

        try
        {
            await DatabaseService.UpdateJournalEntryAsync(currentJournalEntry);
            successMessage = "Entry updated successfully!";
            
            // Reload to get updated timestamp
            await LoadJournalEntryForDate();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteJournalEntry()
    {
        bool confirmed = await Application.Current.MainPage.DisplayAlert(
            "Confirm Delete",
            "Are you sure you want to delete this entry?  This action cannot be undone.",
            "Yes, Delete",
            "Cancel"
        );

        if (!confirmed)
            return;

        errorMessage = string.Empty;
        successMessage = string.Empty;
        isSaving = true;

        try
        {
            await DatabaseService.DeleteJournalEntryAsync(currentJournalEntry);
            successMessage = "Entry deleted successfully!  Redirecting...";
            
            // Wait a moment for user to see the message
            await Task.Delay(1000);
            
            // Navigate to home
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }
}