@page "/entry"
@page "/entry/{DateParam}"
@using JournalNote.Models
@using JournalNote.Services
@using Microsoft.JSInterop
@inject DatabaseService DatabaseService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Journal Entry</PageTitle>

<div class="container mt-4">
    <h2>@pageTitle</h2>
    <hr />

    @if (! string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }

    @if (! string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label"><strong>Date:</strong></label>
                <input type="date" 
                       class="form-control" 
                       value="@selectedDate.ToString("yyyy-MM-dd")" 
                       @onchange="OnDateChanged" />
            </div>

            @if (isLoadingJournalEntry)
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading... </span>
                    </div>
                    <p class="mt-2">Loading entry...</p>
                </div>
            }
            else
            {
                <div class="mb-3">
                    <label class="form-label"><strong>Title:</strong></label>
                    <input type="text" 
                           class="form-control" 
                           @bind="currentJournalEntry.Title" 
                           placeholder="Enter title" 
                           maxlength="200" />
                </div>

                <!-- Primary Mood Section -->
                <div class="mb-4">
                    <div class="mood-section-header">
                        <label class="form-label"><strong>Primary Mood:</strong> <span class="text-danger">*Required</span></label>
                    </div>
                    <MoodSelector 
                        Title="How are you feeling today?"
                        MoodsByCategory="@moodsByCategory"
                        SelectedMoodId="@selectedPrimaryMoodId"
                        OnMoodSelected="@OnPrimaryMoodSelected"
                        MaxSelection="1"
                        AllowDeselect="false" />
                </div>

                <!-- Secondary Moods Section -->
                <div class="mb-4">
                    <div class="mood-section-header">
                        <label class="form-label"><strong>Secondary Moods:</strong> <span class="text-muted">(Optional - Up to 2)</span></label>
                    </div>
                    <MoodSelector 
                        Title="Any other feelings?"
                        MoodsByCategory="@moodsByCategory"
                        SelectedMoodIds="@selectedSecondaryMoodIds"
                        OnMoodSelected="@OnSecondaryMoodSelected"
                        MaxSelection="2"
                        AllowDeselect="true" />
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>Content:</strong></label>
                    
                    <!-- Quill Editor Container -->
                    <div id="editor" style="height: 300px; background: white; border:  2px solid #e0e6ed; border-radius: 10px;"></div>
                </div>

                <div class="d-flex gap-2 flex-wrap mt-4">
                    @if (isEditMode)
                    {
                        <button class="btn btn-primary" @onclick="UpdateJournalEntry" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Update Entry
                        </button>
                        <button class="btn btn-danger" @onclick="DeleteJournalEntry" disabled="@isSaving">
                            Delete Entry
                        </button>
                    }
                    else
                    {
                        <button class="btn btn-success" @onclick="CreateJournalEntry" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            Save Entry
                        </button>
                    }
                    
                    <button class="btn btn-secondary" @onclick="NavigateToHome">
                        Cancel
                    </button>
                </div>
            }
        </div>
    </div>

    @if (isEditMode && currentJournalEntry != null && currentJournalEntry.Id > 0)
    {
        <div class="mt-3">
            <small class="text-muted">
                <strong>Created:</strong> @currentJournalEntry.CreatedAt.ToString("MMMM dd, yyyy h:mm tt")<br />
                <strong>Last Updated:</strong> @currentJournalEntry.UpdatedAt.ToString("MMMM dd, yyyy h:mm tt")
            </small>
        </div>
    }
</div>

@code {
    [Parameter]
    public string?  DateParam { get; set; }

    private JournalEntry currentJournalEntry = new JournalEntry();
    private DateTime selectedDate = DateTime.Today;
    private bool isEditMode = false;
    private bool isLoadingJournalEntry = false;
    private bool isSaving = false;
    private bool isQuillInitialized = false;
    private string errorMessage = string. Empty;
    private string successMessage = string.Empty;
    private string pageTitle = "Create Journal Entry";

    // Mood tracking
    private Dictionary<string, List<Mood>> moodsByCategory = new();
    private int?  selectedPrimaryMoodId;
    private List<int> selectedSecondaryMoodIds = new();

    protected override async Task OnInitializedAsync()
    {
        // Load moods
        await LoadMoodsAsync();

        // If date parameter provided in URL, use it
        if (! string.IsNullOrEmpty(DateParam))
        {
            if (DateTime.TryParse(DateParam, out DateTime parsedDate))
            {
                selectedDate = parsedDate;
            }
        }

        await LoadJournalEntryForDate();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Initialize Quill editor
                await JS.InvokeVoidAsync("initQuill", "editor");
                isQuillInitialized = true;

                // Load content into Quill if editing
                if (! string.IsNullOrEmpty(currentJournalEntry.Content))
                {
                    await JS. InvokeVoidAsync("setQuillHtml", currentJournalEntry.Content);
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"Error initializing editor: {ex.Message}";
                StateHasChanged();
            }
        }
    }

    private async Task LoadMoodsAsync()
    {
        try
        {
            var allMoods = await DatabaseService. GetAllMoodsAsync();
            moodsByCategory = allMoods
                .GroupBy(m => m. Category)
                .ToDictionary(g => g.Key, g => g.ToList());
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading moods: {ex.Message}";
        }
    }

    private async Task OnDateChanged(ChangeEventArgs e)
    {
        if (DateTime.TryParse(e. Value?. ToString(), out DateTime newDate))
        {
            selectedDate = newDate;
            await LoadJournalEntryForDate();
            
            // Update Quill content when date changes
            if (isQuillInitialized)
            {
                await JS.InvokeVoidAsync("setQuillHtml", currentJournalEntry.Content ??  "");
            }
        }
    }

    private async Task LoadJournalEntryForDate()
    {
        isLoadingJournalEntry = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            string dateString = selectedDate.ToString("yyyy-MM-dd");
            var existingJournalEntry = await DatabaseService. GetJournalEntryByDateAsync(dateString);

            if (existingJournalEntry != null)
            {
                // Journal entry exists - switch to edit mode
                currentJournalEntry = existingJournalEntry;
                isEditMode = true;
                pageTitle = $"Edit Entry - {selectedDate: MMMM dd, yyyy}";

                // Load moods
                selectedPrimaryMoodId = currentJournalEntry.PrimaryMoodId;
                
                if (! string.IsNullOrEmpty(currentJournalEntry.SecondaryMoodIds))
                {
                    selectedSecondaryMoodIds = currentJournalEntry.SecondaryMoodIds
                        .Split(',')
                        .Select(id => int. Parse(id.Trim()))
                        .ToList();
                }
                else
                {
                    selectedSecondaryMoodIds = new List<int>();
                }
            }
            else
            {
                // No journal entry - create new
                currentJournalEntry = new JournalEntry
                {
                    Date = dateString,
                    Title = string.Empty,
                    Content = string.Empty
                };
                isEditMode = false;
                pageTitle = $"Create Entry - {selectedDate:MMMM dd, yyyy}";
                
                // Reset moods
                selectedPrimaryMoodId = null;
                selectedSecondaryMoodIds = new List<int>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading entry: {ex.Message}";
        }
        finally
        {
            isLoadingJournalEntry = false;
        }
    }

    private Task OnPrimaryMoodSelected(int moodId)
    {
        selectedPrimaryMoodId = moodId;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnSecondaryMoodSelected(int moodId)
    {
        // Logic handled in MoodSelector component
        StateHasChanged();
        return Task.CompletedTask;
    }

    private async Task CreateJournalEntry()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        // Validation
        if (string.IsNullOrWhiteSpace(currentJournalEntry.Title))
        {
            errorMessage = "Please enter a title. ";
            return;
        }

        if (! selectedPrimaryMoodId.HasValue)
        {
            errorMessage = "Please select a primary mood. ";
            return;
        }

        isSaving = true;

        try
        {
            // Get HTML content from Quill
            var htmlContent = await JS.InvokeAsync<string>("getQuillHtml");
            
            if (string.IsNullOrWhiteSpace(htmlContent) || htmlContent == "<p><br></p>")
            {
                errorMessage = "Please enter some content.";
                isSaving = false;
                return;
            }

            currentJournalEntry.Date = selectedDate. ToString("yyyy-MM-dd");
            currentJournalEntry. Content = htmlContent;
            currentJournalEntry.PrimaryMoodId = selectedPrimaryMoodId.Value;
            currentJournalEntry.SecondaryMoodIds = string.Join(",", selectedSecondaryMoodIds);
            
            await DatabaseService.AddJournalEntryAsync(currentJournalEntry);
            
            successMessage = "Entry created successfully!";
            
            // Reload journal entry to get generated ID and timestamps
            await LoadJournalEntryForDate();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error creating entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task UpdateJournalEntry()
    {
        errorMessage = string. Empty;
        successMessage = string.Empty;

        // Validation
        if (string. IsNullOrWhiteSpace(currentJournalEntry.Title))
        {
            errorMessage = "Please enter a title.";
            return;
        }

        if (!selectedPrimaryMoodId.HasValue)
        {
            errorMessage = "Please select a primary mood.";
            return;
        }

        isSaving = true;

        try
        {
            // Get HTML content from Quill
            var htmlContent = await JS.InvokeAsync<string>("getQuillHtml");
            
            if (string.IsNullOrWhiteSpace(htmlContent) || htmlContent == "<p><br></p>")
            {
                errorMessage = "Please enter some content.";
                isSaving = false;
                return;
            }

            currentJournalEntry.Content = htmlContent;
            currentJournalEntry.PrimaryMoodId = selectedPrimaryMoodId.Value;
            currentJournalEntry.SecondaryMoodIds = string.Join(",", selectedSecondaryMoodIds);
            
            await DatabaseService.UpdateJournalEntryAsync(currentJournalEntry);
            successMessage = "Entry updated successfully!";
            
            // Reload to get updated timestamp
            await LoadJournalEntryForDate();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error updating entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteJournalEntry()
    {
        bool confirmed = await Application.Current.MainPage.DisplayAlert(
            "Confirm Delete",
            "Are you sure you want to delete this entry?  This action cannot be undone.",
            "Yes, Delete",
            "Cancel"
        );

        if (!confirmed)
            return;

        errorMessage = string.Empty;
        successMessage = string.Empty;
        isSaving = true;

        try
        {
            await DatabaseService.DeleteJournalEntryAsync(currentJournalEntry);
            successMessage = "Entry deleted successfully!  Redirecting... ";
            
            // Wait a moment for user to see the message
            await Task.Delay(1000);
            
            // Navigate to home
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }
}