@using JournalNote.Models

<div class="tag-selector">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>@Title</h5>
        <button type="button" class="btn btn-sm btn-outline-primary" @onclick="ToggleCustomTagInput">
            + Custom Tag
        </button>
    </div>

    <!-- Custom Tag Input -->
    @if (showCustomTagInput)
    {
        <div class="custom-tag-input mb-3">
            <div class="input-group">
                <input type="text" 
                       class="form-control" 
                       placeholder="Enter custom tag name..." 
                       @bind="customTagName"
                       @onkeypress="OnCustomTagKeyPress"
                       maxlength="50" />
                <button class="btn btn-success" @onclick="AddCustomTag">Add</button>
                <button class="btn btn-secondary" @onclick="CancelCustomTag">Cancel</button>
            </div>
            @if (! string.IsNullOrEmpty(customTagError))
            {
                <small class="text-danger">@customTagError</small>
            }
        </div>
    }

    <!-- Selected Tags Display -->
    @if (SelectedTagIds.Any())
    {
        <div class="selected-tags mb-3">
            <strong>Selected Tags:</strong>
            <div class="selected-tags-list mt-2">
                @foreach (var tagId in SelectedTagIds)
                {
                    var tag = AllTags.FirstOrDefault(t => t.Id == tagId);
                    if (tag != null)
                    {
                        <span class="selected-tag-badge" style="background-color: @tag.Color">
                            @tag.Name
                            <button type="button" class="tag-remove-btn" @onclick="() => RemoveTag(tagId)">
                                ×
                            </button>
                        </span>
                    }
                }
            </div>
        </div>
    }

    <!-- Predefined Tags -->
    @if (PredefinedTags.Any())
    {
        <div class="tag-section mb-3">
            <h6 class="tag-section-title">Pre-built Tags</h6>
            <div class="tag-grid">
                @foreach (var tag in PredefinedTags)
                {
                    <button type="button" 
                            class="tag-button @(IsSelected(tag.Id) ? "selected" : "")"
                            style="@GetTagStyle(tag)"
                            @onclick="() => ToggleTag(tag.Id)">
                        @tag.Name
                    </button>
                }
            </div>
        </div>
    }

    <!-- Custom Tags -->
    @if (CustomTags.Any())
    {
        <div class="tag-section">
            <h6 class="tag-section-title">Your Custom Tags</h6>
            <div class="tag-grid">
                @foreach (var tag in CustomTags)
                {
                    <button type="button" 
                            class="tag-button @(IsSelected(tag.Id) ? "selected" : "")"
                            style="@GetTagStyle(tag)"
                            @onclick="() => ToggleTag(tag.Id)">
                        @tag.Name
                        <span class="custom-tag-indicator">✨</span>
                    </button>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string Title { get; set; } = "Tags";

    [Parameter]
    public List<Tag> AllTags { get; set; } = new();

    [Parameter]
    public List<Tag> PredefinedTags { get; set; } = new();

    [Parameter]
    public List<Tag> CustomTags { get; set; } = new();

    [Parameter]
    public List<int> SelectedTagIds { get; set; } = new();

    [Parameter]
    public EventCallback<int> OnTagToggled { get; set; }

    [Parameter]
    public EventCallback<Tag> OnCustomTagAdded { get; set; }

    private bool showCustomTagInput = false;
    private string customTagName = string.Empty;
    private string customTagError = string.Empty;

    private bool IsSelected(int tagId)
    {
        return SelectedTagIds.Contains(tagId);
    }

    private async Task ToggleTag(int tagId)
    {
        if (SelectedTagIds.Contains(tagId))
        {
            SelectedTagIds.Remove(tagId);
        }
        else
        {
            SelectedTagIds.Add(tagId);
        }

        await OnTagToggled.InvokeAsync(tagId);
    }

    private async Task RemoveTag(int tagId)
    {
        SelectedTagIds.Remove(tagId);
        await OnTagToggled.InvokeAsync(tagId);
    }

    private void ToggleCustomTagInput()
    {
        showCustomTagInput = !showCustomTagInput;
        customTagName = string.Empty;
        customTagError = string.Empty;
    }

    private void CancelCustomTag()
    {
        showCustomTagInput = false;
        customTagName = string.Empty;
        customTagError = string.Empty;
    }

    private async Task AddCustomTag()
    {
        customTagError = string.Empty;

        if (string.IsNullOrWhiteSpace(customTagName))
        {
            customTagError = "Tag name cannot be empty.";
            return;
        }

        // Check if tag already exists
        if (AllTags.Any(t => t.Name.Equals(customTagName.Trim(), StringComparison.OrdinalIgnoreCase)))
        {
            customTagError = "This tag already exists.";
            return;
        }

        var newTag = new Tag
        {
            Name = customTagName.Trim(),
            IsPredefined = false,
            Color = GetRandomColor()
        };

        await OnCustomTagAdded.InvokeAsync(newTag);

        customTagName = string.Empty;
        showCustomTagInput = false;
    }

    private async Task OnCustomTagKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddCustomTag();
        }
    }

    private string GetTagStyle(Tag tag)
    {
        if (IsSelected(tag.Id))
        {
            return $"background-color: {tag.Color}; color: white; border-color: {tag.Color};";
        }
        else
        {
            return $"border-color: {tag.Color}; color: {tag.Color};";
        }
    }

    private string GetRandomColor()
    {
        var colors = new[]
        {
            "#3498db", "#e74c3c", "#2ecc71", "#f39c12", "#9b59b6",
            "#1abc9c", "#e67e22", "#34495e", "#16a085", "#27ae60"
        };

        var random = new Random();
        return colors[random.Next(colors.Length)];
    }
}