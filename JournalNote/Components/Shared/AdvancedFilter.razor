@using JournalNote.Models

<div class="advanced-filter">
    <div class="filter-header">
        <h5>ğŸ” Advanced Filters</h5>
        <button class="btn btn-sm btn-link text-danger" @onclick="ClearAllFilters">
            Clear All
        </button>
    </div>

    <div class="filter-section">
        <label class="filter-label">
            <span class="label-icon">ğŸ”</span>
            <strong>Search</strong>
        </label>
        <input type="text"
               class="form-control"
               placeholder="Search by title or content..."
               @bind="Filter.SearchTerm"
               @bind:event="oninput"
               @onkeyup="OnFilterChanged" />
    </div>
</div>
<!-- Date Range -->
<div class="filter-section">
    <label class="filter-label">
        <span class="label-icon">ğŸ“…</span>
        <strong>Date Range</strong>
    </label>

    <div class="date-range-inputs">
        <div class="date-input-group">
            <label class="small-label">From:</label>
            <input type="date"
                   class="form-control"
                   @bind="Filter.StartDate"
                   @onchange="OnFilterChanged" />
        </div>

        <div class="date-input-group">
            <label class="small-label">To:</label>
            <input type="date"
                   class="form-control"
                   @bind="Filter.EndDate"
                   @onchange="OnFilterChanged" />
        </div>
    </div>
</div>

<!-- Mood Category -->
<div class="filter-section">
    <label class="filter-label">
        <span class="label-icon">ğŸ˜Š</span>
        <strong>Mood Category</strong>
    </label>

    <select class="form-select" @bind="Filter.MoodCategory" @onchange="OnFilterChanged">
        <option value="">All Categories</option>
        <option value="Positive">Positive</option>
        <option value="Neutral">Neutral</option>
        <option value="Negative">Negative</option>
    </select>
</div>

<!-- Specific Moods -->
<div class="filter-section">
    <label class="filter-label">
        <span class="label-icon">ğŸ­</span>
        <strong>Specific Moods</strong>
    </label>

    <div class="filter-chips">
        @foreach (var mood in AvailableMoods)
        {
            <button type="button"
                    class="filter-chip @(IsMoodSelected(mood.Id) ? "selected" : "")"
                    @onclick="() => ToggleMood(mood.Id)">
                @mood.Icon @mood.Name
            </button>
        }
    </div>
</div>

<!-- Tags -->
<div class="filter-section">
    <label class="filter-label">
        <span class="label-icon">ğŸ·ï¸</span>
        <strong>Tags</strong>
    </label>

    <div class="filter-chips">
        @foreach (var tag in AvailableTags)
        {
            var selected = IsTagSelected(tag.Id);

            <button type="button"
                    class="filter-chip @(selected ? "selected" : "")"
                    style="@(selected
                               ? $"background-color: {tag.Color}; color: white; border-color: {tag.Color};"
                               : $"border-color: {tag.Color}; color: {tag.Color};")"
                    @onclick="() => ToggleTag(tag.Id)">
                @tag.Name
            </button>
        }
    </div>
</div>



@code {
    [Parameter] public EntryFilter Filter { get; set; } = new();
    [Parameter] public EventCallback OnFilterChange { get; set; }

    private async Task OnFilterChanged()
    {
        await OnFilterChange.InvokeAsync();
    }

    private async Task ClearAllFilters()
    {
        Filter.Clear();
        await OnFilterChanged();
    }
    
    [Parameter] public List<Mood> AvailableMoods { get; set; } = new();
    [Parameter] public List<Tag> AvailableTags { get; set; } = new();

    private bool IsMoodSelected(int moodId) => Filter.SelectedMoodIds.Contains(moodId);
    private bool IsTagSelected(int tagId) => Filter.SelectedTagIds.Contains(tagId);

    private async Task ToggleMood(int moodId)
    {
        if (Filter.SelectedMoodIds.Contains(moodId))
            Filter.SelectedMoodIds.Remove(moodId);
        else
            Filter.SelectedMoodIds.Add(moodId);

        await OnFilterChanged();
    }

    private async Task ToggleTag(int tagId)
    {
        if (Filter.SelectedTagIds.Contains(tagId))
            Filter.SelectedTagIds.Remove(tagId);
        else
            Filter.SelectedTagIds.Add(tagId);

        await OnFilterChanged();
    }

}