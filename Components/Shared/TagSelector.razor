@using JournalNote.Models

<div class="tag-selector">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>@Title</h5>
    </div>

    @if (SelectedTagIds.Any())
    {
        <div class="selected-tags mb-3">
            <strong>Selected Tags:</strong>
            <div class="selected-tags-list mt-2">
                @foreach (var tagId in SelectedTagIds)
                {
                    var tag = AllTags.FirstOrDefault(t => t.Id == tagId);
                    if (tag != null)
                    {
                        <span class="selected-tag-badge" style="background-color: @tag.Color">
                            @tag.Name
                            <button type="button" class="tag-remove-btn" @onclick="() => RemoveTag(tagId)">
                                Ã—
                            </button>
                        </span>
                    }
                }
            </div>
        </div>
    }

    @if (PredefinedTags.Any())
    {
        <div class="tag-section mb-3">
            <h6 class="tag-section-title">Available Tags</h6>
            <div class="tag-grid">
                @foreach (var tag in PredefinedTags)
                {
                    <button type="button" 
                            class="tag-button @(IsSelected(tag.Id) ? "selected" : "")"
                            style="@GetTagStyle(tag)"
                            @onclick="() => ToggleTag(tag.Id)">
                        @tag.Name
                    </button>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public string Title { get; set; } = "Tags";
    [Parameter] public List<Tag> AllTags { get; set; } = new();
    [Parameter] public List<Tag> PredefinedTags { get; set; } = new();
    [Parameter] public List<Tag> CustomTags { get; set; } = new();
    [Parameter] public List<int> SelectedTagIds { get; set; } = new();
    [Parameter] public EventCallback<int> OnTagToggled { get; set; }
    [Parameter] public EventCallback<Tag> OnCustomTagAdded { get; set; }

    private bool IsSelected(int tagId) => SelectedTagIds.Contains(tagId);

    private async Task ToggleTag(int tagId)
    {
        if (SelectedTagIds.Contains(tagId))
            SelectedTagIds.Remove(tagId);
        else
            SelectedTagIds.Add(tagId);

        await OnTagToggled.InvokeAsync(tagId);
    }

    private async Task RemoveTag(int tagId)
    {
        SelectedTagIds.Remove(tagId);
        await OnTagToggled.InvokeAsync(tagId);
    }

    private string GetTagStyle(Tag tag)
    {
        if (IsSelected(tag.Id))
            return $"background-color: {tag.Color}; color: white; border-color: {tag.Color};";
        else
            return $"border-color: {tag.Color}; color: {tag.Color};";
    }
}