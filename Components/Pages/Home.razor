@page "/"
@using JournalNote.Models
@using JournalNote.Services
@inject DatabaseService DatabaseService
@inject NavigationManager Navigation

<PageTitle>Dashboard - JournalNote</PageTitle>

<div class="container-fluid mt-4">
    
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="welcome-card">
                <h1 class="display-5 fw-bold">📔 Welcome to JournalNote</h1>
                <p class="lead">@GetGreeting()</p>
                <p class="text-muted mb-0">@DateTime.Now.ToString("dddd, MMMM dd, yyyy")</p>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <!-- Total Entries -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card stat-card-blue">
                <div class="stat-icon">📝</div>
                <div class="stat-content">
                    <h3>@totalEntries</h3>
                    <p>Total Entries</p>
                </div>
            </div>
        </div>

        <!-- Current Streak -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card stat-card-green">
                <div class="stat-icon">🔥</div>
                <div class="stat-content">
                    <h3>@currentStreak</h3>
                    <p>Day Streak</p>
                </div>
            </div>
        </div>

        <!-- This Month -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card stat-card-purple">
                <div class="stat-icon">📅</div>
                <div class="stat-content">
                    <h3>@thisMonthEntries</h3>
                    <p>This Month</p>
                </div>
            </div>
        </div>

        <!-- Longest Streak -->
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card stat-card-orange">
                <div class="stat-icon">🏆</div>
                <div class="stat-content">
                    <h3>@longestStreak</h3>
                    <p>Longest Streak</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">⚡ Quick Actions</h4>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <button class="action-card" @onclick='() => Navigation.NavigateTo("/entry")'>
                <div class="action-icon">✍️</div>
                <h5>New Entry</h5>
                <p>Write today's journal</p>
            </button>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <button class="action-card" @onclick='() => Navigation.NavigateTo("/entries")'>
                <div class="action-icon">📚</div>
                <h5>Browse</h5>
                <p>View all entries</p>
            </button>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <button class="action-card" @onclick='() => Navigation.NavigateTo("/calendar")'>
                <div class="action-icon">📆</div>
                <h5>Calendar</h5>
                <p>Month view</p>
            </button>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <button class="action-card" @onclick='() => Navigation.NavigateTo("/analytics")'>
                <div class="action-icon">📊</div>
                <h5>Analytics</h5>
                <p>View insights</p>
            </button>
        </div>
    </div>

    <!-- Recent Entries & Writing Prompt -->
    <div class="row">
        <!-- Recent Entries -->
        <div class="col-md-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">📖 Recent Entries</h5>
                </div>
                <div class="card-body">
                    @if (recentEntries != null && recentEntries.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var entry in recentEntries)
                            {
                                <a href="/entries" class="list-group-item list-group-item-action recent-entry-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@entry.Title</h6>
                                        <small>@GetRelativeDate(entry.Date)</small>
                                    </div>
                                    <p class="mb-1 text-muted small">@GetPreview(entry.Content)</p>
                                </a>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5 text-muted">
                            <div class="empty-state-icon">📝</div>
                            <p class="mb-3">No entries yet</p>
                            <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/entry")'>
                                Create Your First Entry
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar: Writing Prompt & Quick Stats -->
        <div class="col-md-4 mb-4">
            <!-- Writing Prompt -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">💡 Writing Prompt</h6>
                </div>
                <div class="card-body">
                    <p class="small mb-3">@GetRandomPrompt()</p>
                    <button class="btn btn-sm btn-info w-100" @onclick='() => Navigation.NavigateTo("/entry")'>
                        Start Writing
                    </button>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">Quick Stats</h6>
                </div>
                <div class="card-body">
                    <div class="stat-row">
                        <span>First Entry:</span>
                        <strong>@(firstEntryDate?.ToString("MMM dd, yyyy") ?? "N/A")</strong>
                    </div>
                    <div class="stat-row">
                        <span>Last Entry:</span>
                        <strong>@(lastEntryDate?.ToString("MMM dd, yyyy") ?? "N/A")</strong>
                    </div>
                    <div class="stat-row">
                        <span>Days Active:</span>
                        <strong>@daysActive</strong>
                    </div>
                    <div class="stat-row">
                        <span>Completion Rate:</span>
                        <strong>@completionRate%</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

@code {
    private int totalEntries = 0;
    private int currentStreak = 0;
    private int longestStreak = 0;
    private int thisMonthEntries = 0;
    private int daysActive = 0;
    private double completionRate = 0;
    private DateTime? firstEntryDate;
    private DateTime? lastEntryDate;
    private List<JournalEntry> recentEntries = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        try
        {
            // Get all entries
            var allEntries = await DatabaseService.GetAllEntriesAsync();
            totalEntries = allEntries?.Count ?? 0;

            if (allEntries != null && allEntries.Any())
            {
                // Recent entries
                recentEntries = allEntries.Take(5).ToList();

                // This month entries
                var thisMonth = DateTime.Now.Month;
                var thisYear = DateTime.Now.Year;
                thisMonthEntries = allEntries.Count(e =>
                {
                    if (DateTime.TryParse(e.Date, out var date))
                    {
                        return date.Month == thisMonth && date.Year == thisYear;
                    }
                    return false;
                });

                // Dates
                var dates = allEntries
                    .Select(e => DateTime.TryParse(e.Date, out var d) ? (DateTime?)d : null)
                    .Where(d => d.HasValue)
                    .Select(d => d.Value)
                    .OrderBy(d => d)
                    .ToList();

                if (dates.Any())
                {
                    firstEntryDate = dates.First();
                    lastEntryDate = dates.Last();
                    daysActive = dates.Distinct().Count();

                    var totalDays = (DateTime.Now - firstEntryDate.Value).Days + 1;
                    completionRate = totalDays > 0 ? Math.Round((daysActive / (double)totalDays) * 100, 1) : 0;
                }

                // Get streak info
                var streakInfo = await DatabaseService.GetStreakInfoAsync();
                currentStreak = streakInfo?.CurrentStreak ?? 0;
                longestStreak = streakInfo?.LongestStreak ?? 0;
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Dashboard load error: {ex.Message}");
        }
    }

    private string GetGreeting()
    {
        var hour = DateTime.Now.Hour;
        if (hour < 12) return "Good Morning! ☀️";
        if (hour < 18) return "Good Afternoon! 🌤️";
        return "Good Evening! 🌙";
    }

    private string GetRelativeDate(string dateStr)
    {
        try
        {
            var date = DateTime.Parse(dateStr);
            var days = (DateTime.Now.Date - date.Date).Days;

            if (days == 0) return "Today";
            if (days == 1) return "Yesterday";
            if (days < 7) return $"{days} days ago";
            return date.ToString("MMM dd, yyyy");
        }
        catch
        {
            return dateStr;
        }
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return "No content";

        var cleaned = System.Text.RegularExpressions.Regex.Replace(content, "<.*?>", "");
        cleaned = System.Net.WebUtility.HtmlDecode(cleaned);

        return cleaned.Length > 100 ? cleaned.Substring(0, 100) + "..." : cleaned;
    }

    private string GetRandomPrompt()
    {
        var prompts = new[]
        {
            "What are you grateful for today?",
            "Describe a moment that made you smile.",
            "What's one thing you learned recently?",
            "Write about a challenge you overcame.",
            "What are your goals for this week?",
            "Describe your perfect day.",
            "What inspires you right now?",
            "Write about someone who impacted your life.",
            "What does success mean to you?",
            "Reflect on a recent accomplishment."
        };

        var random = new Random();
        return prompts[random.Next(prompts.Length)];
    }
}